#!/bin/bash
#SBATCH --job-name=k2-vllm
#SBATCH --nodes=4
#SBATCH --ntasks-per-node=1

set -x

export MODEL_NAME=/fsx/ubuntu/.cache/huggingface/hub/models--moonshotai--Kimi-K2-Instruct/snapshots/c52f808f632c07eb8361388616b1d04749373a94

export MASTER_IP=$(scontrol show hostnames $SLURM_JOB_NODELIST | head -n 1)
export PORT=13579

srun -l \
    --mpi=pmix --cpu-bind=none \
    --container-image /fsx/ubuntu/belevich/vllm-ep/vllm-ep-nvshmem-aws-2.sqsh \
    --container-mounts=${HF_HOME}:${HF_HOME} \
    bash -c 'set -x; 
    [ "$SLURM_PROCID" -eq 0 ] && EXTRA_FLAGS="" || EXTRA_FLAGS="--headless --data-parallel-start-rank $((4 * SLURM_PROCID))";
vllm serve $MODEL_NAME \
    $EXTRA_FLAGS \
    --port 8000 \
    --served-model-name kimi-k2 \
    --trust-remote-code \
    --data-parallel-size 16 \
    --data-parallel-size-local 4 \
    --data-parallel-address $MASTER_IP \
    --data-parallel-rpc-port $PORT \
    --enable-expert-parallel \
    --max-num-batched-tokens 8192 \
    --max-num-seqs 256 \
    --gpu-memory-utilization 0.85 \
    --enable-auto-tool-choice \
    --tool-call-parser kimi_k2'
